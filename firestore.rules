rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user's familyId (safely handles missing user document and empty strings)
    function getUserFamilyId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      let familyId = userDoc.exists && userDoc.data.familyId != null ? userDoc.data.familyId : null;
      // Return null if familyId is empty string (user hasn't joined a family yet)
      return familyId != null && familyId != '' ? familyId : null;
    }
    
    // Helper function to check if user belongs to a family
    function belongsToFamily(familyId) {
      return request.auth != null && getUserFamilyId() == familyId;
    }
    
    // Helper function to check if user belongs to the family in a document
    // This works for both individual document reads and queries
    function belongsToDocumentFamily() {
      return request.auth != null 
        && getUserFamilyId() != null 
        && resource.data.familyId != null
        && getUserFamilyId() == resource.data.familyId;
    }
    
    // Helper function to check if user can create a document with a specific familyId
    function canCreateForFamily(familyId) {
      return request.auth != null && getUserFamilyId() != null && getUserFamilyId() == familyId;
    }
    
    // Users can read/write their own user document
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // Prevent user deletion
    }
    
    // Family data
    match /families/{familyId} {
      // Allow reading families (needed for invite code lookup and joining)
      allow read: if request.auth != null;
      
      // Allow creating a new family (user doesn't have familyId yet)
      allow create: if request.auth != null;
      
      // Allow updating family if user belongs to it
      allow update: if request.auth != null && belongsToFamily(familyId);
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Shopping lists - subcollection of families
    match /families/{familyId}/shoppingLists/{listId} {
      allow read: if request.auth != null && belongsToFamily(familyId);
      allow create: if request.auth != null && belongsToFamily(familyId);
      allow update, delete: if request.auth != null && belongsToFamily(familyId);
      
      // Shopping items - subcollection of shopping lists
      match /items/{itemId} {
        allow read: if request.auth != null && belongsToFamily(familyId);
        allow create: if request.auth != null && belongsToFamily(familyId);
        allow update, delete: if request.auth != null && belongsToFamily(familyId);
      }
    }
    
    // Direct expenses - subcollection of families
    match /families/{familyId}/directExpenses/{expenseId} {
      allow read: if request.auth != null && belongsToFamily(familyId);
      allow create: if request.auth != null && belongsToFamily(familyId);
      allow update, delete: if request.auth != null && belongsToFamily(familyId);
    }
    
    // Legacy shopping items (for backward compatibility - can be removed if not needed)
    match /shopping/{itemId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
    
    // Budget categories - scoped to family
    match /budgets/{categoryId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      // For update, check both existing and new data to handle transactions
      allow update: if belongsToDocumentFamily() || canCreateForFamily(request.resource.data.familyId);
      allow delete: if belongsToDocumentFamily();
    }
    
    // Tasks - scoped to family
    match /tasks/{taskId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
    
    // Events - scoped to family
    match /events/{eventId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
  }
}

