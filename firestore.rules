rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user's familyId
    function getUserFamilyId() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId
        : null;
    }
    
    // Helper function to check if user belongs to a family
    function belongsToFamily(familyId) {
      return request.auth != null && 
        getUserFamilyId() != null && 
        getUserFamilyId() != '' &&
        familyId != null &&
        getUserFamilyId() == familyId;
    }
    
    // Helper function to check if user belongs to the family in a document
    function belongsToDocumentFamily() {
      return request.auth != null && 
        getUserFamilyId() != null && 
        getUserFamilyId() != '' &&
        resource.data.familyId != null &&
        resource.data.familyId != '' &&
        getUserFamilyId() == resource.data.familyId;
    }
    
    // Helper function to check if user can create a document with a specific familyId
    function canCreateForFamily(familyId) {
      return request.auth != null && 
        getUserFamilyId() != null && 
        getUserFamilyId() != '' &&
        familyId != null && 
        familyId != '' &&
        getUserFamilyId() == familyId;
    }
    
    // Users can read/write their own user document
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Personal Notes - Users can only read/write their own notes
    match /notes/{noteId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Family data
    match /families/{familyId} {
      // Allow reading families (needed for invite code lookup and joining)
      allow read: if request.auth != null;
      
      // Allow creating a new family (user doesn't have familyId yet)
      allow create: if request.auth != null;
      
      // Allow updating family if user belongs to it
      allow update: if request.auth != null && belongsToFamily(familyId);
      
      // Prevent deletion
      allow delete: if false;
      
      // Shopping lists - subcollection of families
      match /shoppingLists/{listId} {
        allow read: if request.auth != null && belongsToFamily(familyId);
        allow create: if request.auth != null && belongsToFamily(familyId);
        allow update, delete: if request.auth != null && belongsToFamily(familyId);
        
        // Shopping items - subcollection of shopping lists
        match /items/{itemId} {
          allow read: if request.auth != null && belongsToFamily(familyId);
          allow create: if request.auth != null && belongsToFamily(familyId);
          allow update, delete: if request.auth != null && belongsToFamily(familyId);
        }
      }
      
      // Direct expenses - subcollection of families
      match /directExpenses/{expenseId} {
        allow read: if request.auth != null && belongsToFamily(familyId);
        allow create: if request.auth != null && belongsToFamily(familyId);
        allow update, delete: if request.auth != null && belongsToFamily(familyId);
      }
    }
    
    // Legacy shopping items (for backward compatibility)
    match /shopping/{itemId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
    
    // Budget periods - top-level collection
    match /budgetPeriods/{periodId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update: if belongsToDocumentFamily() || 
        (request.auth != null && canCreateForFamily(request.resource.data.familyId));
      allow delete: if belongsToDocumentFamily();
      
      // Budget categories - subcollection of budget periods
      match /budgets/{categoryId} {
        allow read: if belongsToDocumentFamily();
        allow create: if canCreateForFamily(request.resource.data.familyId);
        allow update: if belongsToDocumentFamily() || 
          (request.auth != null && canCreateForFamily(request.resource.data.familyId));
        allow delete: if belongsToDocumentFamily();
      }
    }
    
    // Budget categories - top-level collection (legacy, for backward compatibility)
    match /budgets/{categoryId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update: if belongsToDocumentFamily() || 
        (request.auth != null && canCreateForFamily(request.resource.data.familyId));
      allow delete: if belongsToDocumentFamily();
    }
    
    // Tasks - top-level collection
    match /tasks/{taskId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
    
    // Events - top-level collection
    match /events/{eventId} {
      allow read: if belongsToDocumentFamily();
      allow create: if canCreateForFamily(request.resource.data.familyId);
      allow update, delete: if belongsToDocumentFamily();
    }
  }
}
